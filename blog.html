<!DOCTYPE html>
<html lang="en">
<head>
	<meta http-equiv="content-type" content="text/html; charset=utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1.0">

	<title>Jesper Stefansson</title>

	<link rel="stylesheet" href="/css/blackburn.css">
	<link rel="stylesheet" href="/css/main.css">

	<link rel="stylesheet" href="/css/fork-awesome.min.css">
</head>
<body>

<div id="layout">
	<button type="button" id="menu_btn" class="hidden-print">
		<span class="icon-bar"></span>
		<span class="icon-bar"></span>
		<span class="icon-bar"></span>
	</button>

	<div id="menu" class="side-menu hidden-print">
		<a class="side-menu-heading brand" href="/">Jesper Stefansson</a>
		<ul class="side-menu-list">
			<li class="side-menu-item"><a class="side-menu-link" href="/"><i class="fa fa-home fa-fw"></i>Home</a></li>
			<li class="side-menu-item"><a class="side-menu-link" href="/resume.html"><i class="fa fa-graduation-cap fa-fw"></i>Resume</a></li>
			<li class="side-menu-item"><a class="side-menu-link" href="/blog.html"><i class="fa fa-file-text fa-fw"></i>Blog</a></li>
		</ul>

		<ul class="side-menu-list social">
			<li class="side-menu-item"><a class="side-menu-link" href="https://mastodon.gamedev.place/@jesper" target="_blank"><i class="fa fa-mastodon-square fa-fw"></i>Mastodon</a></li>
			<li class="side-menu-item"><a class="side-menu-link" href="https://linkedin.com/in/jesperstefansson" target="_blank"><i class="fa fa-linkedin-square fa-fw"></i>LinkedIn</a></li>
			<li class="side-menu-item"><a class="side-menu-link" href="https://github.com/grouse" target="_blank"><i class="fa fa-github-square fa-fw"></i>GitHub</a></li>
		</ul>
	</div>



	<div id="main">

<div class="header">
	<h1>echo</h1>
</div>

<div class="content">
	<div class="post-meta clearfix">
		<div class="tags"><i class="fa fa-tag"></i><a href="/posts/tag/jam.html">jam</a>, <a href="/posts/tag/godot.html">godot</a>, <a href="/posts/tag/gamedev.html">gamedev</a></div>
		<div class="date">
			<i class="fa fa-calendar fa-f2"></i>
			<time>2025-11-24</time>
		</div>
	</div>
	
	

<p>During the 2025 GMTK game jam I made a small prototype in Godot to learn more about the engine. The theme of the jam was "loop", and I got stuck thinking about time loops and how you could use recorded player state to solve puzzles with your past, like a temporal single player co-op game.</p>



<p>The game is playable in the browser at <a href="https://grousejst.itch.io/echo">https://grousejst.itch.io/echo</a>

<p>The jam took place between 30th of July and 3rd of August 2025, during which I wrote Echo over the course of about 2 days, using mostly primitives and a handful of assets from Kenney's Asset packs, <a href="https://kenney.nl/assets">https://kenney.nl/assets</a>. It's a really small prototype, but I had fun making it, and it was honest work!</p>

<h1>Levels</h1>
<p>The prototype contains 6 small levels, with ideas for many more filling my notebooks. Below I outline the first 3 levels that introduce the rules of the looping, culminating in a hopefully satisfying realisation as the player realises how the ghost interacts with the world.</p>

<h2>The past will set you free</h2>
<img class="expandable" src="/assets/echo/level1_0.png"/>
<p>The first level introduces the player to the concept of looping and solving the puzzle using the ghost of the previous iteration. As such, the level is a simple locked door that is opened with a pressure switch. Step off the switch, the door closes again. The only solution is to to stand still on the switch for a while, loop the iteration, and wait for the ghost to stand on the switch and let you through.</p>
<img class="expandable" src="/assets/echo/level1_1_switch.png"/>
<img class="expandable" src="/assets/echo/level1_2_closed.png"/>
<img class="expandable" src="/assets/echo/level1_3_ghost.png"/>

<h2>Planning ahead</h2>
<p>The second level is a small step forward in the same vein as level 1, the only difference is introducing a measure of timing and having to plan ahead by standing still on the first switch long enough to let future you walk through, and then moving over to the 2nd switch.</p>
<img class="expandable" src="/assets/echo/level2_0.png"/>
<img class="expandable" src="/assets/echo/level2_1_first.png"/>
<img class="expandable" src="/assets/echo/level2_2_second.png"/>

<h2>Ghost continuum</h2>
<img class="expandable" src="/assets/echo/level3_0.png"/>
<p>In level 3, I am extending the concepts from the previous levels to introduce the idea of ghosts breaking continuity, from the perspective of the present. In short, that ghost does not interact with physics, and can walk through walls or doors, if they were not there during the ghost's version of the world.</p>

<p>In practice, this is merely a side effect of recording the state of the player and position and replaying it. If I were to instead record input and rely on deterministic simulations, achieving the same result would require a more complex solution.</p>

<video controls><source src="/assets/echo/level3.webm"/></video>

<h1>Record & replay state</h1>

<p>Recording the player state simply means pushing the player position and rotation onto an ever-growing buffer, rate limited to 30Hz. For the jam, I didn't have time to think too much about how long I wanted to the recorded state window to be, and what that would mean for the design of the game.</p>

<p>I chose 30Hz recording frequency primarily to have a fixed framerate in the recording that would be consistent, but as a high enough framerate I didn't need practically consider things like interpolating through corners, as such errors would be too small to make a difference for the purpose of the jam.</p>

<p>Memory is not really a concern when recording so little state; the naive approach shown below and used in the jam results in about 720 bytes per second for storing the state, or 43.2 KiB per minute. With modern hardware and such a small game, recording just a single entity's state, you'd be able to record for literally days (59 MiB per day) before this started making a dent in your RAM usage.</p>
<code class="block">func record_state(position : Vector3, rotation : Vector3) -&gt; void:
	if record_start_time &lt; 0: return

	if recorded_state.size() &gt; 0 && (time-recorded_state[recorded_state.size()-1].end_time_msec) &lt; record_rate_ms:
		return

	if recorded_state.size() &gt; 0: recorded_state.back().end_time_msec = time
	var state : RecordedState = RecordedState.new()
	state.position = position 
	state.rotation = rotation 
	recorded_state.append(state)
</code>

<p>Replaying the previously recorded state linearly interpolates between the most current state and the next to achieve smooth playback, no matter the frequency of the recorded state.</p>

<code class="block">func replay_state():
	var delta_msec = Time.get_ticks_usec() - replay_start_time 
	while replay_i &lt; replay_state.size() && delta_msec &gt;= replay_state[replay_i].end_time_msec:
		replay_i += 1

	if replay_i &lt; replay_state.size():
		var pos = replay_state[replay_i].position
		var rot = replay_state[replay_i].rotation

		var pos_n = pos
		var rot_n = rot

		var alpha = 0
		if replay_i+1 &lt; replay_state.size():
			pos_n = replay_state[replay_i + 1].position
			rot_n = replay_state[replay_i + 1].rotation
			var quotient = replay_state[replay_i + 1].end_time_msec - replay_state[replay_i].end_time_msec
			if quotient &gt; 0: alpha = (delta_msec - replay_state[replay_i].end_time_msec) / float(quotient)

		pos = pos.lerp(pos_n, alpha)
		rot = rot.slerp(rot_n, alpha)

		position = pos
		rotation = rot
</code>

</div>
<div class="header">
	<h1>the umbrella dilemma</h1>
</div>

<div class="content">
	<div class="post-meta clearfix">
		<div class="tags"><i class="fa fa-tag"></i><a href="/posts/tag/short.html">short</a></div>
		<div class="date">
			<i class="fa fa-calendar fa-f2"></i>
			<time>2021-03-06</time>
		</div>
	</div>
	
	

<p>On the rainiest day of the year, Jack was walking home. It was February, so to say it was the rainiest day of the year wasn't saying much, but being February, it was the type of rain that chills you to the bone and makes you consider whether it had intended to be snow, but someone had made a mistake. Ordinarily, Jack liked rain. When it was summer. Or late spring. Autumn rain in particular held a special place in his heart.</p>

<p>But it wasn't autumn. It was February. Jack tried to pretend to like the rain, regardless of how cold it was making him, as a steady stream of droplets made their way from his soaked hair into his eyes. Jack didn't have an umbrella. It's not that he didn't have one with him, he didn't own one. Today, he decided, was the day he'd buy an umbrella. Or rather, tomorrow. Right now, all he wanted was to get home and out of the rain. Tomorrow would be a better day to go to the shops. It probably wouldn't be raining tomorrow.</p>



<p>But what kind of umbrella should he get? The kind that folded in and retracted were really easy to carry around. You'd be far more likely to have the umbrella handy for unexpected rainfall. But he detested the handles on those things. They were always short, stubby things that were awkward to hold properly, especially when the wind picked up and threatened to take the umbrella away from you. And besides, they were always too small. It seemed like they were purposefully designed to keep your head dry but let about half of the rest of your body get soaked. The big, full size umbrellas seemed like far better umbrellas. They protected your entire body from the cold rain. They were like parents, he thought, hovering around their child, shielding them from all the dangers of the world while the child skips on, blissfully unaware. But just like how the parents' protection becomes overbearing and stifling when there aren't any dangers around that the child can't handle, the large umbrellas become oppressive to carry around when it isn't raining.</p>

<p>He'd check online when he arrived home, he decided. Someone must have been anguished by the same dilemma before, and they would have come to some conclusion about what the best umbrellas were. There might even be some type of umbrella he never knew about that solved every problem, and there'd be reviews of it.</p>

<p>Once Jack finally made it home, he wiped the wet mud from his shoes on the non-existing door mat and tracked muddy water all over the hallway. He'd never gotten a doormat. Never gotten around to it, and besides, it was such a hassle to clean the floors with a doormat that you needed to deal with. And it was important that whatever banal message, or lack thereof, that was on the doormat you got was a message you could stand by for years to come.</p>

<p>Doing his best to contain the mud to the entrance, he undressed and changed into dry clothes, then glanced at the clock in the hallway. Five thirty. He could do some quick searches online before he had to worry about food.</p>

<p>The best umbrella. 542,000,000 results. There were regular, full size umbrellas, the standard retractable ones, a bunch of transparent, extra domed umbrellas that he suddenly recalled having seen in some pictures from Japan, umbrellas with a hole on top and another layer of cloth over the hole, a bit like a hot air balloon, to protect it from damage when the wind caught it, lopsided umbrellas, parasols, photography diffuser umbrellas, and cocktail umbrellas. Some of those were, perhaps, more useful than others as a tool to protect yourself from rain, but Jack had been right. There was a whole world of different umbrellas out there. All he had to do was choose, and hope he could find one at the store tomorrow.</p>

<p>As he went clicking through the different umbrellas, reading and watching video reviews, the clock ticked past six and was well on its way to seven before Jack had the presence of mind to look at it. Crap. He still had to eat, and it was getting too late to cook anything worthwhile.</p>

<p>He decided to order in. A couple clicks online, and like magic there'd be food at his doorstep in half an hour, while he went about doing some chores around the house. The 21st century.</p>

<p>Except, it all took a bit longer than half an hour. As he was scrolling through available restaurants on the food delivery website, he had to decide what he wanted to eat. Pizza? He had had pizza a couple days ago. Maybe he'd order a burger. Oh, but burgers never survived the delivery particularly well. He finally decided to order some Indian food, and went looking for his regular, comfortable Indian restaurant.</p>

<p>He knew he liked it, it had been his default Indian restaurant for three years, but for some reason he decided to look at the reviews. There were a bunch of bad ones in the past month. Slow delivery. Wrong order. One even complained about under-cooked chicken. Uh-oh. Maybe he'd try out a different restaurant today. Maybe he'd just order pizza again.</p>

<p>Eventually, finally, he had decided what to order and from whom to order it, and he hit confirm on the ordering page. Seven forty-five. He decided to skip the chores for today, and went into the living room to find something to watch for the evening.</p> 

<p>Starting up his video streaming app of choice, Jack started scrolling through the selection. He had about twenty-three movies and series on his watchlist, but he quickly went through and discarded all of them. Most of them were movies that you didn't just watch, you had to be in the right mood for them and feel like you could devote the entire running length to really watch the movie. Maybe a light comedy?</p>

<p>When the sushi finally arrived, Jack still hadn't selected anything to watch. In frustration, he hit the shuffle button. And then he hit it again. And a few more times before a nature documentary show came up. He threw the remote aside with an audible sigh. It wasn't really what he was in the mood for, but it'd probably be good and at this point he just wanted to eat his food and go to bed.</p>

<p>Jack woke up to the smattering of rain on his bedroom window. For a moment he lay there, listening, enjoying the soothing sound of randomness striking the window. Sporadically the wind would pick up, creating a wave of high frequency smattering, and then it'd slow down until it almost seemed like it had stopped. And then it'd pick up again. He looked over to the window and saw the droplets hanging on to the surface, some of them growing heavy and falling down, many of them staying put and refracting the light into thousands of tiny, upside down versions of the outside world. And then he remembered that it was February, and he had to get to work.</p>

<p>Preparing the best he could for the outside conditions, which wasn't all that much when you didn't have an umbrella, Jack went to work. He'd definitely get an umbrella on his way home. He'd go and buy a small retractable one so he could carry it with him at all times and never again be forced to arrive to work soaked to his underwear.</p>

<p>Eight and something hours later, Jack was on his way home. He had promised himself to go buy an umbrella after work, but he was on his way home. Today had been a lousy day, and he just wanted to get home, put his feet up, and watch something stupid on the TV for a couple of hours. And anyway, it had stopped raining, and there wasn't any rain on the forecast. It'd be days before the next rain, maybe weeks. He could get an umbrella later.</p>
</div>
<div class="header">
	<h1>apples vs oranges</h1>
</div>

<div class="content">
	<div class="post-meta clearfix">
		<div class="tags"></div>
		<div class="date">
			<i class="fa fa-calendar fa-f2"></i>
			<time>2021-02-22</time>
		</div>
	</div>
	
	

<p>Comparing apples to oranges is one of society's greatest unsolved mysteries. So many people have tried and failed that it has given birth to the idiom "comparing apples to oranges" as a way of saying that something is incomparable.</p>

<p>Not daunted by the failure of civilisation for thousands of years before me, and fueled by the random, racing thoughts of insomnia, this is my humble attempt to crack the problem, once and for all.</p> 



<p>According to folk wisdom, an apple a day keeps the doctor away. As such, I'd recommend apples to anyone with a phobia for white robes or who wishes to avoid persons with doctorate titles in their twitter display name.</p>

<p>The skin of an apple can easily get stuck in your teeth. This is very uncomfortable for anyone, but for someone with dentures or braces it may ruin the experience altogether. For the dentured people, I instead recommend oranges. Provided that they have access to a young person to peel their oranges, as peeling an orange requires a grip strength often not present in the very old.</p>

<p>Oranges are a well known remedy for scurvy. If you're planning an extended voyage at sea, pack a few barrels of oranges. Also consider bringing a few rugby balls to stave off loneliness.</p>

<p>Peeling an orange can also prove a squirting hazard of acidic liquid that, if it gets in your eyes, can be very painful. I suggest wearing protective eyewear at all times when peeling or consuming oranges.</p>

<p>When consuming an orange one has to be constantly on the look out for seeds. Although our modern oranges often have very few or zero seeds, an unexpected rogue seed can not only be particularly unpleassant, it may prove a choking hazard which could drastically lower the life expectancy of the subject.</p>

<p>Oranges, being orange, has a much higher contrast to the surrounding environment compared to apples, which are usually green and disappear in grass or yellow-red which disappear in leaves. If you are worried about losing your fruits, or have a sadistic parent who are trying to ruin easter by hiding fruits instead of sweets, oranges should be your fruit of choice.</p>

<p>A dropped apple quickly develop discoloured blemishes on the skin, hinting at a compromised and mushy piece of apple underneath. The same drop with an orange usually do not develop the same kind of sign of damage on the the outside, but once peeled, might nevertheless reveal damage to the flesh of the orange. However, this damage is usually pretty minor and the orange is usually still good to eat.</p>

<p>When it's all said and done, it seems pretty clear to me that oranges have the upper hand. Unless you're old and lack the grip strength required to peel the orange, in which case you probably want to avoid apples anyway, as avoiding doctors at that stage seems like avoiding the very people still keeping you alive.</p>

<p>Finally, apple juice is far superior to orange juice, and therefore apples are better than oranges.</p>
</div>
<div class="header">
	<h1>fsg</h1>
</div>

<div class="content">
	<div class="post-meta clearfix">
		<div class="tags"><i class="fa fa-tag"></i><a href="/posts/tag/programming.html">programming</a></div>
		<div class="date">
			<i class="fa fa-calendar fa-f2"></i>
			<time>2020-08-08</time>
		</div>
	</div>
	
	

<p>I wrote my own site generator, it's called fsg. The s and g stands for Site Generator. I'll leave it to the creativity of the reader to figure out what the f stands for. It took a weekend. It's written for myself and by myself, so it doesn't have many bells and whistles, but it does what I need.</p>



<img src="/img/fsg.png" />

<p>I don't put as much content on this site as I think I should. Most of the time I just update my resume whenever that needs updating. Despite that, every single time I've updated this site I've ran into issues with Hugo, which is the static site generator I use. Or did use, I should say. See, I update my site rarely enough that I generally forget which version of hugo I was using. So every time I download the latest, naively thinking that it'll be fine. Every time I have to spend a day fixing it, dealing with various changes in the framework.</p>

<p>Lately I've been telling myself that at least a part of the reason I haven't been putting more stuff on here is because of frustrations with the site generator situation, which brings us to the present.</p>

<p>There's really only a couple things I wanted out of fsg. It doesn't need to be able to deal with particularly large websites. I don't mind writing the posts in html. All I really need out of it is a way to specify a template or a couple different templates to use for the different pages, and to generate different lists of posts on the front page and the full blog list. For a while I was considering just going back to doing it the way I first learned to make websites and duplicate each page's html entirely and just deal with the hassle of updating menus and site layout changes across all pages. Instead I chose the road of procrastination, until a conversation on twitter prompted me to think about it for a bit and I had one of those classic "y'know what, I could probably knock that out in a weekend". And then I did.</p>

<p>The results are available at <a href="https://github.com/grouse/fsg">https://github.com/grouse/fsg</a>. Alongside the generator in fsg.cpp the repo also contains the source asset files, which are intentionally vanilla html files with a bit of custom syntax in html comment blocks which are parsed by the generator in fsg.cpp to correctly insert page titles, look up templates, static pages, etc. It also has a server mode that opens a socket on port 80 and serves the generated site back. And it has file watches on the source asset to automatically re-generate the site as the source assets change.</p>

<p>There are definitely a bunch of improvements that could be made in the site generation part, but most of them would be so marginal an improvement I doubt I'll ever bother. The only thing I am likely to do on that end is auto-escaping the contents of code blocks, because that would be trivial to do and because it has already been a bit of a headache to ensure symbols like <code>&lt;</code> don't break the code block. The other thing is figuring out a way for the webserver to keep the socket open to the browser and push new data on it whenever the site is re-generated, or in some way make the browser re-request the same page when its source assets change. That one I'd be inclined to actually solve if writing becomes more of a habit. It's also very wasteful in what it has to re-generate when things change, and there are probably a bunch of memory-leaks, and I don't care about either at all; it re-generates the site faster than I can look over to the browser window and the webserver just will not be running long enough for memory to ever become a problem.</p>

<p>I'm not really gonna say anything more about details of the implementation of fsg. It's really not all that interesting. It's just my little tool that I wrote in a spare weekend for my own needs, and what I ended up with is simply what I ended up with following the process of implementing the most straight forward, simplest solution to each problem as I came across them, step by step. That process is something I find much more interesting and valuable, and so that's what I'll be ending this post talking about.</p>

<p>I enjoy writing things from scratch, mostly or entirely without libraries. Definitely without frameworks. It allows me to learn things at a deep level which is usable in the future to a much greater degree than some trivia knowledge about how to massage some framework into doing what you need, and it gives me opportunity to practice the fundamentals - every time I write a lexer it gets a little better and I get a little faster at writing it. I think we all just need to invent the wheel a bunch of times before we actually arrive at a wheel that works well. It also just doesn't take as long as many seem to think - if you limit yourself to solving the problems that you actually need to solve. Programmers trying to solve the imaginary problem of tomorrow and making their solutions more general happens far too often, which inherently leads to a solution more complex than required. When applied to a personal tool, you might be surprised how simple things end up.</p>

<p>By the way, did you know that the earliest archeological find of a wheel is a potter's wheel? I should say we're lucky our ancestors re-invented that wheel a few times to get to wheels for flour mills, trolleys, carts, and carriages before they got to the smooth, rubberised wheels of the modern car.</p>

</div>
<div class="header">
	<h1>defer</h1>
</div>

<div class="content">
	<div class="post-meta clearfix">
		<div class="tags"><i class="fa fa-tag"></i><a href="/posts/tag/programming.html">programming</a></div>
		<div class="date">
			<i class="fa fa-calendar fa-f2"></i>
			<time>2017-04-14</time>
		</div>
	</div>
	
	

<p>I'm not a big fan of the destructors in C++. Don't get me wrong, they can certainly be useful. I just think they solve a problem in a way that could've been implemented in a much more powerful way, without the implicit changes in behaviour or performance characteristics that adding a destructor comes with. I'm also not at all a fan of non-trivial code hidden away in destructors that I wasn't expecting, but that's primarily a programmer error.</p>



<p>Enough teasing, here's the code:</p>

<code class="block">template &lt;typename F&gt;
struct Defer {
	Defer(F f) : f(f) {}
	~Defer() { f(); }
	F f;
};

template &lt;typename F&gt;
Defer&lt;F&gt; defer_create(F f) {
	return Defer&lt;F&gt;(f);
};

#define defer__(line) defer_ ## line
#define defer_(line) defer__(line)

struct DeferDummy {};

template&lt;typename F&gt;
Defer&lt;F&gt;operator+ (DeferDummy, F&& f)
{
	return defer_create&lt;F&gt;(std::forward&lt;F&gt;(f));
}

#define defer auto defer_(__LINE__) = DeferDummy() + [&]()
</code>

<p>Full credit of this snippet goes to the folks over at https://handmade.network where this is copied from, with a small change to the naming of the expansion macros to not clash with glibc.</p>

<div class="note">
<p>Don't prepend anything with double underscore, you're probably gonna clash with
something, somewhere as it's reserved by the compilers in C and C++.</p>
</div>

<p>In short, the way this works is that you pass a lambda expression to the constructor for the <code>Defer</code> struct, that it calls during its destructor. The <code>DeferDummy</code> struct exists so that we can default-construct an object and pass in the lambda using <code>operator+</code>, this is entirely done in order to keep the defer macro usage neat and simple.</p>

<p>I've seen this sort of thing mentioned in a few places, and it's certainly not a concept invented by C++ macro magicians. It's a first class feature in Go, Swift, and probably a bunch of other languages. Personally, I was first introduced to it during one of Jonathan Blow's JAI compiler streams. It's just recently that I decided to actually incorporate it into my own projects and see how I actually like it in practice.</p>

<p>It turns out, I like it. I like it a lot. But first, some usage code to figure out what that macro magic actually allows us to do.</p>

<code class="block">void foo()
{
	defer { printf("world 1!\n"); };
	defer { printf("hello, "); };

	defer {
		printf("hello, ");
		printf("world 2!\n");
	};
}

// outputs:
//   hello world 2!
//   hello world 1!
</code>

<p>Referring back to the macro magic, the first statement expands into</p>

<code class="block">auto defer_(__LINE__) = DeferDummy() + [&](){ printf("world 1!\n"); };</code>

<p>In other words, the defer macro starts a lambda expression declaration but doesn't properly open or close it, we do that ourselves with the <code>{};</code> The <code>;</code> after the curly braces might look weird at first glance, and would indeed be the first thing   would want removed in a proper first class version of defer, but it's required as long as we're forced to hack the feature in using destructors and lambda expressions.</p>

<p>Because <code>defer</code> is implemented using destructors of <code>Defer</code> objects, the destructors are called in opposite order of declaration, like unwinding a stack. This turns out to not only make a lot of sense, but be exactly what we want, as we want any defer statements close to the beginning of a scope to be called later than the ones near the end, in order to get proper order of execution in the cases where the latter defer depends on state cleaned up by the former defer.</p>

<p>There's a few things this allows us to do. The most obvious one is to add a defer statement freeing a resource or closing a file handle just after we've opened it, making it much more obvious that this is taken care of. This is particularly useful if you like to do early returns, while also avoiding use of <code>goto</code> to jump to clean-up code. Of course, all of this is one of the primary reasons for a destructor, but defer is much more versatile as you can trivially customise which statements are execute  or whether it depends on some state in the function, without having to change or implement a destructor for a struct which would incur those changes everywhere the struct is already used, potentially changing performance characteristics or behaviour dependence.</p>

<p>Defer is one of the only things I really want added to the C++ specification as a first class citizen, but I've all but given up on the C++ committee actually adding something useful to the language, so this macro magic solution will keep me happy for now.</p>

</div>
<div class="header">
	<h1>live code editing</h1>
</div>

<div class="content">
	<div class="post-meta clearfix">
		<div class="tags"><i class="fa fa-tag"></i><a href="/posts/tag/programming.html">programming</a></div>
		<div class="date">
			<i class="fa fa-calendar fa-f2"></i>
			<time>2017-04-08</time>
		</div>
	</div>
	
	

<p>Fast iteration times on large projects is often cited as one of the primary reasons to incorporate a scripting language, such as Lua, Python or JavaScript, into the project. The primary downside to this is overall complexity, performance, maintenance, and debugging. So wouldn't it be great if we can get the benefits of scripting languages with none of, or close to none of, the downsides?</p>



<div class="note">
<p>This post is written from the perspective of game development. With that said, most if not all principles are applicable to any software project of similar size and complexity.</p>
</div>

<p>Certainly there are other benefits to a more high level scripting language, particularly if the rest of the code base is in a rather low level programming language, such as C or C++. It allows people who would generally not classify themselves as programmers for their primary skill or interest, like designers, artists and writers, to put their content into the game and seeing how it works in practice.</p>

<p>This is not a benefit I'm going to put a lot of effort into exploring or considering, simply because I can't speak for what kind of tangible benefits designers, artists and the like can derive from a scripting language when looking at the project as a whole compared to the amount of man hours required to make a scripting language integration perform well, not to mention that the debugging facilities for such an integration tend to be far worse than what we have available for native languages.</p>

<p>So how do we get the fast iteration time of scripting languages using ordinary C or C++? It turns out, it's actually not that complicated. In fact, most of us have been only a few steps away from achieving it while doing other things. The solution is dynamically linked libraries, <code>.dll</code> on Windows, <code>.so</code> on Linux.</p>

<code class="block">// file: foo.c
void foo(int a, int b)
{
	// ...
}

// file: bar.c
typedef void foo_t(int, int);
foo_t *foo = nullptr;

void foo_stub(int, int) {}

void* load_foo()
{
	void *lib = dlopen("foo.so", RTLD_NOW | RTLD_GLOBAL);

	if (lib) {
		foo = (foo_t*)dlysym(lib, "foo");
		// ...
	}

	if (!foo) foo = &foo_stub;
	// ...

	return lib;
}
</code>

<p>The above snippet is a simple example of how to dynamically load code at runtime, the code is written for Linux using <code>dlopen</code> and <code>dlsym</code> functions, the Windows equivalent is copied verbatim but with the necessary replacements to use <code>LoadLibrary</code> and <code>GetProcAddress</code> instead of <code>dlopen</code> and <code>dlsym</code>.</p>

<p>So, first of, there are a couple of different things that needs to be done to get the code base ready to be loaded at runtime. I've already implemented live code editing in one of my main hobby projects, Leary (https://github.com/grouse/leary), so I'l  be using that as a reference to describe what needs to be done and how to achieve it.</p>

<h1>Figure out what to reload</h1>

<p>The first thing that needs to be done is deciding which parts of the code base should be loaded at runtime and start making the changes necessary to make it possible to compile these parts into a <code>.dll</code> or <code>.so</code>. For Leary I wanted as much as possible to fall in this category. That means initialisation, input handling, simulation, and rendering.</p>

<h1>Make a few small, concise entry points to the reloaded code</h1>

<p>We could simply reload every single function in the code, but that is quickly going to turn into a nightmare to maintain. Instead, I suggest you provide a very simple interface to the code that is reloaded with just a few different functions and move all code behind those, making a concise and easy to maintain interface between the dynamically loaded code and the main entry point of the program.</p>

<p>In Leary, I decided to make this interface four functions: <code>game_init</code>, <code>game_pre_reload</code>, <code>game_reload</code>, and <code>game_update</code>. The purpose for <code>game_pre_reload</code> might not be immediately apparent, and at the time of writing this post it actually isn't required for Leary, but it's there so that if anything relies on other outside state, such as Vulkan driver state, the game code has a chance to make sure that this state is ready to be reloaded. In the case of Vulkan, which is the most immediate case it'll be needed for in Leary, it means I can make sure the graphics device is idle and have finished all its work before I reload the code and recreate shader, buffer and texture resources.</p>

<p><code>game_reload</code> is called after the game module has been reloaded. The function is used so that we can pass all the global state that we've gathered from the module back to be set accordingly. As you might imagine, the less global state you rely on the less this function has to be doing.</p>

<p><code>game_init</code> and <code>game_update</code> are fairly self evident. <code>game_init</code> is called once at program startup to set up the primary state object that it then returns for the primary program to keep track of across module reloads. <code>game_update</code> is our single entry point into the module that we call every frame with the game state object from <code>game_init</code> to perform work.</p>

<div class="note">
<p>In a more traditional input-based program without a non-stalling infinite main loop traditional to games, you can imagine a fifth function <code>work_available</code> which would block the main loop in the main program until there are input events
that need processing or we have found in some other way that we need to perform work.</p>
</div>

<p>After these code changes the function to load all the game code in Leary off of the disk looks like this:</p>

<code class="block">#define DLOAD_FUNC(lib, name) (name##_t*)dlsym(lib, #name)

void* load_code()
{
	void *lib = dlopen("/path/to/game.so", RTLD_NOW | RTLD_GLOBAL);

	if (lib) {
		game_init       = DLOAD_FUNC(lib, game_init);
		game_pre_reload = DLOAD_FUNC(lib, game_pre_reload);
		game_reload     = DLOAD_FUNC(lib, game_reload);
		game_update     = DLOAD_FUNC(lib, game_update);
	}

	if (!game_init)       game_init       = &game_init_stub;
	if (!game_pre_reload) game_pre_reload = &game_pre_reload_stub;
	if (!game_reload)     game_reload     = &game_reload_stub;
	if (!game_update)     game_update     = &game_update_stub;

	return lib;
}
</code>

<h1>Coalesce state</h1>

<p>If all you do is run the above code in your <code>main</code> entry point once, it should 'just work'. But that's not why we're here. We want to be able to continuously reload the code as it changes.</p>

<p>If you're not relying on any static variables, global or local, in your code base, you're in luck. Just make sure <code>game_init</code> returns the primary state object that you pass into <code>game_update</code> and you're pretty much good to go.</p>

<p>If you do use any static variables you need to understand how static initialisation works, in particular in regards to dynamically linked libraries.</p>
 
<h2>Static local variables</h2>

<p>Static variables that are declared locally in function or block scope is initialised at first execution of that scope. The deinitialisation of the static variables occurs at program or module exit. Because we'll be reloading the code continuously we'l  be calling <code>dlclose</code> followed by <code>dlopen</code> every time we reload. Static deinitialisation of all block or function scoped static variables in the dynamic library will occur at <code>dlclose</code>.</p>

<p>There are a few potential pitfalls with this that we need to take care of. The first obvious one is if the static variable is being allocated on the heap that means we end up leaking the memory of that static variable every time we reload the code. That'd be bad. The other pitfall is if the static variable is initialised by executing some non-trivial code. That <i>might</i> be bad.</p>

<p>There isn't really any simple solution that fits all in this case. You're just gonna have to go through each static variable and figure out if multiple initialisations and deinitialisatons of the variable would result in bad behaviour. As a personal preference, I tend to avoid the type of static variables that would cause these types of problems for a number of different reasons, live code editing being just one minor one of them. These reasons may become the subject of a future post.</p>

<h2>Static global variables</h2>

<p>Static global variables will be initialised with <code>dlopen</code> and deinitialised with <code>dlclose</code>. Fortunately, these are a lot easier to handle cleanly in our use case of reloading the module.</p>

<p>Put simply, avoid initialising static variables using function calls, e.g. <code>static Foo foo = some_foo_init();</code>. Similarly as with the static block and function scoped variables, these assignments mean that <code>some_foo_init</code> will be executed every time we reload the module. The same thing applies if the static variable is used to track state that needs to persist across reloads, as the reload will reset the state.</p>

<p>Instead, put all these initialisations behind an <code>init</code> or <code>reload</code> function. In the case of Leary, that's exactly what <code>game_reload</code> is used for. The state object from <code>game_init</code> is used to store and restore the values of the variables.</p>

<h1>Putting it all together</h1>

<p>At last. We've coalesced all the state required into a single object that we can pass into the drastically reduced entry point interface that we've defined, and we've (hopefully) cleaned up all static variables or made sure they all behave well when being initialised multiple times. It's time to write the main loop that pulls it all together and reloads the code when appropriate.</p>

<code class="block">typedef void game_init_t(GameState*);
typedef void game_pre_reload_t(GameState*);
typedef void game_reload_t(GameState*);
typedef void game_update_t(GameState*);

void game_init_stub(GameState*)       {}
void game_pre_reload_stub(GameState*) {}
void game_reload_stub(GameState*)     {}
void game_update_stub(GameState*)     {}

game_init_t       *game_init       = nullptr;
game_pre_reload_t *game_pre_reload = nullptr;
game_reload_t     *game_reload     = nullptr;
game_update_t     *game_update     = nullptr;

#define DLOAD_FUNC(lib, name) (name##_t*)dlsym(lib, #name)
void* load_code()
{
	void *lib = dlopen("/path/to/game.so", RTLD_LAZY | RTLD_GLOBAL);

	if (lib) {
		game_init       = DLOAD_FUNC(lib.handle, game_init);
		game_pre_reload = DLOAD_FUNC(lib.handle, game_pre_reload);
		game_reload     = DLOAD_FUNC(lib.handle, game_reload);
		game_update     = DLOAD_FUNC(lib.handle, game_update);
	}

	if (!game_init)       game_init       = &game_init_stub;
	if (!game_pre_reload) game_pre_reload = &game_pre_reload_stub;
	if (!game_reload)     game_reload     = &game_reload_stub;
	if (!game_update)     game_update     = &game_update_stub;

	return lib;
}

void main(int, char **)
{
	void *lib = load_code();

	GameState game = {};
	game_init(&game);

	while (true) {
		game_update(&game);

		game_pre_reload(&game);
		dlclose(lib);
		lib = load_code();

		game_reload(&game);
	}

	return 0;
}
</code>

<p>Naturally, reloading the game code every frame is a horrendously bad idea. It'll tank the performance and you're pretty much asking for trouble. There are a number of ways to get around that problem: either reload the code after some predetermined, arbitrary amount of time, or use a way to determine whether the <code>game.so</code> file has changed and only reload the code when that happens. To accomplish the latter you can simply query the last modified date of the file whenever you want to reload it, or you can look into the various platform specific ways that exist to be notified via callbacks or events when a file changes. Right now in Leary I simply query the last modified time of the dynamic library every second and reload it if it has changed.</p>

<h1>Final words</h1>

<p>There you have it. Natively compiled C/C++ code reloaded dynamically at runtime, allowing you to very rapidly change a piece of code, compile it, and have the changes immediately take effect in the running program. It's magic.</p>

<p>Some caveats still exist. For example, if the layout of your data changes, by changing the order of variables in a struct or their type you're going to have to do a proper full reload of the game. Secondly, as alluded to earlier in the post, you're going to have to take extra care that any libraries that you use won't behave badly when reloaded dynamically like this.</p>

<p>Debugging can also be somewhat temperamental at times. Visual Studio in particular likes to lock both the <code>.pdb</code> and executable files when it's debugging so that they can't be changed at all, and GDB seems to freak out somewhat when symbols have changed without it realising.</p>

<p>In the case of Visual Studio's locking you pretty much just have to make sure to copy the binaries and debug symbols to intermediate copies before you load them, so that the symbols and binaries being generated by the compiling isn't the ones you're actually loading.</p>

<p>For GDB's freak out, I'll get back to you on that one. I'm sure there are reasonable solutions to work around it.</p>

<p>These problems have, so far, for me, been rather secondary in priority. Generally when I want to debug something I'm not very interested in being able to do live code editing, so I have a simple <code>#define</code> to turn it off in favour of traditional static linking.</p>

<p>As a programmer very comfortable in the low level trenches of C/C++, this then gives me the best of both worlds. When I need fast iteration testing gameplay I turn on the live code editing and I just have to compile for my changes to take effect immediately, when I need to debug I turn it off and I get the stable, 'normal', statically linked code that GDB and Visual Studio plays nicely with. All with none of the massive performance cost of scripting languages or the immense man hours required for the maintenance.</p>

</div>
<div class="header">
	<h1>Hello, World</h1>
</div>

<div class="content">
	<div class="post-meta clearfix">
		<div class="tags"></div>
		<div class="date">
			<i class="fa fa-calendar fa-f2"></i>
			<time>2017-01-12</time>
		</div>
	</div>
	
	

<p>Just like every blog needs a "Hello World" post to start things off, so does this one. And just like every introductionary post promising times of grandeur, interesting content providing food for thought, and frequent updates, just to fall into obscurity with no update in sight for months, this one is no exception.</p>



<p>My name's Jesper Stefansson. I'm an aspiring game developer from Sweden currently employed by Feral Interactive to port video games to Linux. At the time of writing this employment has resulted in primary involvement in the Linux ports Tomb Raider, the 2013 reboot, and Total War: WARHAMMER.</p>

<p>So what's with the blog? Well, I've always quite enjoyed writing, and over the years I've deluded myself into thinking I'm rather decent at it. And what better way to share in the insanity that is every day life as a game developer, as my hair grows greyer and my mind ever more cynical.</p>

<p>As alluded to by the start of this post, I have a few ideas and rough notes for a few topics I wish to write about. I also have far too many books to read, and code to code, so we'll see what happens. Don't hold your breath.</p>

<p>Until next time,<br/>Jesper</p>

</div>
</div>
</div>

<script src="/js/ui.js"></script>
</body>
</html>
